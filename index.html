<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Glasses Procedure Creator</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Mobile responsive padding */
        @media (min-width: 768px) {
            .container {
                padding: 24px;
            }
        }

        .header {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Responsive header */
        @media (min-width: 768px) {
            .header {
                padding: 32px;
                margin-bottom: 24px;
            }
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1e3a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        /* Larger header on desktop */
        @media (min-width: 768px) {
            .header h1 {
                font-size: 28px;
            }
        }

        .header p {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .main-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Responsive main panel */
        @media (min-width: 768px) {
            .main-panel {
                padding: 32px;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        /* Responsive form spacing */
        @media (min-width: 768px) {
            .form-group {
                margin-bottom: 24px;
            }
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #1e3a8a;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            color: #374151;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 400;
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        /* Better touch targets on mobile */
        @media (max-width: 767px) {
            .input-field {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        .input-field:focus {
            outline: none;
            border-color: #1e3a8a;
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }

        .input-field::placeholder {
            color: #9ca3af;
        }

        .instructions-container {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 4px;
        }

        /* Responsive instructions container */
        @media (min-width: 768px) {
            .instructions-container {
                padding: 20px;
            }
        }

        .section-header {
            font-size: 12px;
            font-weight: 600;
            color: #1e3a8a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .instruction-container {
            margin-bottom: 8px;
        }

        .instruction-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        /* Responsive instruction row */
        @media (min-width: 768px) {
            .instruction-row {
                gap: 12px;
                margin-bottom: 8px;
            }
        }

        .insert-button-row {
            display: flex;
            justify-content: center;
            margin-bottom: 8px;
        }

        .insert-btn {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #d1d5db;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .insert-btn:hover {
            background: #1e3a8a;
            color: #ffffff;
            border-color: #1e3a8a;
            transform: scale(1.1);
        }

        /* Larger touch targets on mobile */
        @media (max-width: 767px) {
            .insert-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
        }

        .step-number {
            background: #1e3a8a;
            color: #ffffff;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            flex-shrink: 0;
            border-radius: 4px;
        }

        /* Larger touch targets on mobile */
        @media (max-width: 767px) {
            .step-number {
                width: 36px;
                height: 36px;
            }
        }

        .instruction-input {
            flex: 1;
        }

        .remove-btn {
            background: #ef4444;
            color: #ffffff;
            border: none;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        /* Larger touch targets on mobile */
        @media (max-width: 767px) {
            .remove-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .add-btn, .upload-btn, .action-btn, .generate-btn, .copy-nfc-btn {
             border-radius: 4px;
        }

        .add-btn {
            background: #1e3a8a;
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Better mobile buttons */
        @media (max-width: 767px) {
            .add-btn {
                padding: 12px 16px;
                font-size: 13px;
            }
        }

        .add-btn:hover {
            background: #1e40af;
        }

        .upload-btn {
            background: #dc2626; /* Changed from green to red */
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        /* Better mobile buttons */
        @media (max-width: 767px) {
            .upload-btn {
                padding: 12px 16px;
                font-size: 13px;
            }
        }

        .upload-btn:hover {
            background: #b91c1c; /* Darker red on hover */
        }

        /* Responsive button container */
        .button-container {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .button-container {
                gap: 12px;
                flex-wrap: nowrap;
            }
        }

        .generate-btn {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 16px 24px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        /* Better mobile generate button */
        @media (max-width: 767px) {
            .generate-btn {
                padding: 18px 24px;
                font-size: 16px;
            }
        }

        .generate-btn:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .output-panel {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            padding: 20px;
            margin-top: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        /* Responsive output panel */
        @media (min-width: 768px) {
            .output-panel {
                padding: 24px;
                margin-top: 24px;
            }
        }

        .output-header {
            font-size: 12px;
            font-weight: 600;
            color: #dc2626; /* Changed from green to red */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .json-display {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            padding: 16px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 13px;
            color: #374151;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-bottom: 16px;
            border-radius: 4px;
        }

        /* Better mobile code display */
        @media (max-width: 767px) {
            .json-display {
                font-size: 12px;
                padding: 12px;
            }
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        /* Responsive action buttons */
        @media (min-width: 768px) {
            .action-buttons {
                gap: 12px;
                flex-wrap: nowrap;
            }
        }

        .action-btn {
            background: #1e3a8a;
            color: #ffffff;
            border: none;
            padding: 10px 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .action-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Better mobile action buttons */
        @media (max-width: 767px) {
            .action-btn {
                padding: 12px 16px;
                font-size: 13px;
                min-width: 120px;
            }
        }

        @media (min-width: 768px) {
            .action-btn {
                flex: initial;
            }
        }

        .action-btn:not(:disabled):hover {
            background: #1e40af;
        }
        
        #upload-procedure-btn {
            background-color: #16a34a; /* A nice green for upload */
        }
        
        #upload-procedure-btn:not(:disabled):hover {
            background-color: #15803d;
        }

        .info-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 13px;
            border-radius: 4px;
        }

        .info-section strong {
            color: #1e3a8a;
            font-weight: 600;
        }

        .info-section code {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 2px 6px;
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            color: #475569;
            word-break: break-all;
            border-radius: 4px;
        }

        /* Better mobile code blocks */
        @media (max-width: 767px) {
            .info-section code {
                font-size: 11px;
                padding: 3px 6px;
            }
        }

        .status-bar {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: #ffffff;
            border: 1px solid #d1d5db;
            padding: 8px 12px;
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            max-width: calc(100vw - 32px);
            word-wrap: break-word;
            border-radius: 4px;
            z-index: 100;
        }

        /* Mobile status bar */
        @media (max-width: 767px) {
            .status-bar {
                position: relative;
                bottom: auto;
                right: auto;
                margin-top: 16px;
                font-size: 10px;
                text-align: center;
            }
        }

        .status-valid {
            color: #15803d; 
        }

        .status-invalid {
            color: #dc2626;
        }

        /* QR Code and NFC section styles */
        .qr-nfc-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            margin-top: 16px;
            text-align: center;
            border-radius: 8px;
        }

        .qr-nfc-header {
            font-size: 12px;
            font-weight: 600;
            color: #1e3a8a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .qr-code-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            margin-bottom: 16px;
            display: inline-block;
        }

        .nfc-string {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 12px;
            color: #475569;
            word-break: break-all;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        /* Responsive QR/NFC section */
        @media (max-width: 767px) {
            .nfc-string {
                font-size: 11px;
                padding: 10px;
            }
        }

        .copy-nfc-btn {
            background: #dc2626;
            color: #ffffff;
            border: none;
            padding: 8px 16px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-nfc-btn:hover {
            background: #b91c1c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Smart Glasses Procedure Creator</h1>
            <p>Industrial Procedure Generator</p>
        </div>
        
        <div class="main-panel">
            <form>
                <div class="form-group">
                    <label class="form-label">Procedure Title</label>
                    <input type="text" id="procedure-title" class="input-field" placeholder="Coffee machine initialization sequence" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Instructions</label>
                    <div class="instructions-container" id="instructions-container">
                        <!-- Instructions will be dynamically added here -->
                    </div>
                    <div class="button-container">
                        <button type="button" class="add-btn">+ Add Instruction</button>
                        <button type="button" class="upload-btn">Upload JSON</button>
                        <input type="file" id="json-upload" accept=".json" style="display: none;">
                    </div>
                </div>

                <button type="submit" class="generate-btn">Generate Procedure</button>
            </form>

            <div class="output-panel" style="display: none;">
                <div class="output-header">Generated Procedure</div>
                
                <div class="json-display"></div>
                
            <div class="action-buttons">
                <button class="action-btn" id="share-btn" style="display: none;">Share Link & QR</button>
                <button class="action-btn" id="copy-json-btn">Copy JSON</button>
                <button class="action-btn" id="download-file-btn">Download File</button>
                <button class="action-btn" id="upload-procedure-btn">Upload & Get Link</button>
            </div>

                <!-- This section will be hidden until upload is complete -->
                <div id="links-section" style="display: none;">
                    <div class="action-buttons" style="display:none;" id="post-upload-buttons">
                      <button class="action-btn" id="download-procedure-btn">Download Procedure</button>
                    </div>
                    <div class="info-section"></div>
                    <div class="qr-nfc-section">
                        <div class="qr-nfc-header">NFC Tag & QR Code</div>
                        <div class="qr-code-container">
                            <canvas id="qr-canvas" width="200" height="200"></canvas>
                        </div>
                        <div class="nfc-string" id="nfc-string"></div>
                        <button class="copy-nfc-btn">Copy NFC String</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <span></span>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        // --- CONFIGURATION ---
        const MAX_INSTRUCTIONS = 50;
        const MAX_CHAR_PER_INSTRUCTION = 200;
        const PROFANITY_LIST = ['fucker', 'motherfucker', 'shitballs', 'cunt', 'twat', 'shit', 'fuck', 'ass', 'bitch'];

        // --- STATE ---
        let currentProcedure = null;

        // --- DOM ELEMENTS ---
        const DOMElements = {
            form: document.querySelector('form'),
            titleInput: document.getElementById('procedure-title'),
            instructionsContainer: document.getElementById('instructions-container'),
            addBtn: document.querySelector('.add-btn'),
            uploadBtn: document.querySelector('.upload-btn'),
            jsonUploadInput: document.getElementById('json-upload'),
            statusBar: document.querySelector('.status-bar span'),
            outputPanel: document.querySelector('.output-panel'),
            jsonDisplay: document.querySelector('.json-display'),
            copyJsonBtn: document.getElementById('copy-json-btn'),
            downloadFileBtn: document.getElementById('download-file-btn'),
            uploadProcedureBtn: document.getElementById('upload-procedure-btn'),
            linksSection: document.getElementById('links-section'),
            infoSection: document.querySelector('.info-section'),
            qrCanvas: document.getElementById('qr-canvas'),
            nfcStringEl: document.getElementById('nfc-string'),
            copyNfcBtn: document.querySelector('.copy-nfc-btn'),
            downloadProcedureBtn: document.getElementById('download-procedure-btn'),
            postUploadButtons:   document.getElementById('post-upload-buttons') // ← add this
        };
        
        // --- UTILITY FUNCTIONS ---
        const generateUID = () => (Math.random() + 1).toString(36).substring(2, 10);
        const sanitizeForFilename = (title) => title.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, '_').substring(0, 30);
        const checkProfanity = (text) => {
            const lowerText = text.toLowerCase();
            return PROFANITY_LIST.some(word => new RegExp(`\\b${word}\\b`, 'i').test(lowerText));
        };

        // --- CORE UI FUNCTIONS ---
        function updateStepNumbers() {
            const stepNumbers = DOMElements.instructionsContainer.querySelectorAll('.step-number');
            stepNumbers.forEach((step, index) => {
                step.textContent = String(index + 1).padStart(2, '0');
            });
        }

        function createInstructionContainer(instructionText = '') {
            const container = document.createElement('div');
            container.className = 'instruction-container';
            container.innerHTML = `
                <div class="instruction-row">
                    <div class="step-number">00</div>
                    <input type="text" class="input-field instruction-input" placeholder="Enter instruction" maxlength="${MAX_CHAR_PER_INSTRUCTION}" value="${instructionText}">
                    <button type="button" class="remove-btn">×</button>
                </div>
                <div class="insert-button-row">
                    <button type="button" class="insert-btn" title="Insert step here">+</button>
                </div>`;
            
            container.querySelector('.remove-btn').addEventListener('click', () => removeInstruction(container));
            container.querySelector('input').addEventListener('input', updateStatusBar);
            container.querySelector('.insert-btn').addEventListener('click', () => insertInstruction(container));
            
            return container;
        }
        
        function addInstruction(focus = true) {
            if (DOMElements.instructionsContainer.querySelectorAll('.instruction-row').length >= MAX_INSTRUCTIONS) {
                alert(`Maximum ${MAX_INSTRUCTIONS} instructions allowed.`);
                return;
            }
            const newContainer = createInstructionContainer();
            DOMElements.instructionsContainer.appendChild(newContainer);
            if (focus) newContainer.querySelector('input').focus();
            updateStepNumbers();
            updateStatusBar();
        }

        function insertInstruction(relativeContainer) {
            if (DOMElements.instructionsContainer.querySelectorAll('.instruction-row').length >= MAX_INSTRUCTIONS) {
                alert(`Maximum ${MAX_INSTRUCTIONS} instructions allowed.`);
                return;
            }
            const newContainer = createInstructionContainer();
            relativeContainer.insertAdjacentElement('afterend', newContainer);
            newContainer.querySelector('input').focus();
            updateStepNumbers();
            updateStatusBar();
        }
        
        function removeInstruction(container) {
            if (DOMElements.instructionsContainer.querySelectorAll('.instruction-row').length <= 1) {
                alert('At least one instruction is required.');
                return;
            }
            container.remove();
            updateStepNumbers();
            updateStatusBar();
        }

        function getInstructionsFromDOM() {
            const inputs = DOMElements.instructionsContainer.querySelectorAll('.instruction-input');
            return Array.from(inputs).map(input => input.value.trim());
        }

        function updateStatusBar() {
            const instructions = getInstructionsFromDOM();
            const title = DOMElements.titleInput.value;
            const totalChars = instructions.reduce((sum, inst) => sum + inst.length, 0);
            
            const hasErrors = instructions.some(inst => inst.length > MAX_CHAR_PER_INSTRUCTION || checkProfanity(inst)) || checkProfanity(title);
            
            const status = hasErrors ? 'INVALID' : 'VALID';
            const statusClass = hasErrors ? 'status-invalid' : 'status-valid';
            
            DOMElements.statusBar.textContent = `STEPS: ${instructions.filter(i => i).length}/${MAX_INSTRUCTIONS} • TITLE/STEPS STATUS: ${status}`;
            DOMElements.statusBar.className = statusClass;
        }
        
        // --- PROCEDURE GENERATION & VALIDATION ---
        function validateProcedure(title, instructions) {
            const errors = [];
            if (!title) errors.push('Title is required.');
            if (title.length > 100) errors.push('Title must be 100 characters or less.');
            if (checkProfanity(title)) errors.push('Title contains inappropriate language.');
            if (instructions.length === 0 || instructions.every(i => !i)) errors.push('At least one instruction is required.');
            if (instructions.length > MAX_INSTRUCTIONS) errors.push(`Maximum ${MAX_INSTRUCTIONS} instructions allowed.`);
            
            instructions.forEach((instruction, index) => {
                if (instruction.length > MAX_CHAR_PER_INSTRUCTION) errors.push(`Step ${index + 1} exceeds ${MAX_CHAR_PER_INSTRUCTION} character limit.`);
                if (checkProfanity(instruction)) errors.push(`Step ${index + 1} contains inappropriate language.`);
            });
            return errors;
        }

        function handleGenerateProcedure() {
            const title = DOMElements.titleInput.value.trim();
            const instructions = getInstructionsFromDOM().filter(val => val.length > 0);
            
            const errors = validateProcedure(title, instructions);
            if (errors.length > 0) {
                alert('Validation errors:\n\n' + errors.join('\n'));
                return;
            }
            
            const uid = generateUID();
            const sanitizedTitle = sanitizeForFilename(title);
            
            currentProcedure = {
                data: {
                    title: title,
                    uid: uid,
                    instructions: instructions.map((inst, i) => ({ step: i + 1, instruction: inst }))
                },
                filename: `${sanitizedTitle}_${uid}`
            };
            
            displayInitialOutput();
        }

        // --- OUTPUT & UPLOAD ---
        function displayInitialOutput() {
            const jsonString = JSON.stringify(currentProcedure.data, null, 2);
            DOMElements.jsonDisplay.textContent = jsonString;
            DOMElements.outputPanel.style.display = 'block';
            DOMElements.linksSection.style.display = 'none'; // Hide links until uploaded
            DOMElements.uploadProcedureBtn.disabled = false;
            DOMElements.uploadProcedureBtn.textContent = 'Upload & Get Link';
            DOMElements.outputPanel.scrollIntoView({ behavior: 'smooth' });
        }

        async function uploadProcedure() {
            if (!currentProcedure) return;

            // THIS IS THE URL OF YOUR NEW GLITCH PROXY SERVER
            const proxyUrl = "https://carnation-jet-apparel.glitch.me/upload";

            const uploadBtn = DOMElements.uploadProcedureBtn;
            const originalButtonText = uploadBtn.textContent;
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            // Create a Blob from the procedure JSON
            const procedureJSON = JSON.stringify(currentProcedure.data, null, 2);
            const blob = new Blob([procedureJSON], { type: 'application/json' });

            // Use FormData to send the file to your proxy
            const formData = new FormData();
            formData.append('file', blob, `${currentProcedure.filename}.json`);

            try {
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    body: formData // No 'Content-Type' header needed; the browser sets it for FormData
                });

                const result = await response.json();

                if (!response.ok) {
                    // Use the error message from the server if available
                    throw new Error(result.error || `Server responded with status: ${response.status}`);
                }

                // The server sends back { url: '...' } on success
                const fileUrl = result.url;
                uploadBtn.textContent = 'Upload Complete';
                displayFinalLinks(fileUrl);

            } catch (error) {
                console.error('Upload error:', error);
                alert(`Failed to upload procedure. Please try again.\nError: ${error.message}`);
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalButtonText;
            }
        }
        
        function displayFinalLinks(fileUrl) {
            // IMPORTANT: Replace this with the URL where you are hosting the project
            const baseUrl = "https://your-username.github.io/your-repo-name"; 
            
            const landingPageUrl = `${baseUrl}/landing.html?uid=${currentProcedure.data.uid}&file=${fileUrl}`;
            const nfcString = `${currentProcedure.data.uid}|${fileUrl}`;
            const intentUrl = `intent://assistantactions?task=Download_Procedure` +
                              `&par1=${currentProcedure.data.uid}` +
                              `&par2=${encodeURIComponent(fileUrl)}` +
                              '#Intent;scheme=tasker;package=net.dinglisch.android.taskerm;end';
        
            //-- fill the info panel
            DOMElements.infoSection.innerHTML = `
                <strong>Filename:</strong> <code>${currentProcedure.filename}.json</code><br>
                <strong>Procedure ID:</strong> <code>${currentProcedure.data.uid}</code><br>
                <strong>Live URL:</strong> <code>${fileUrl}</code><br>
                <strong>NFC Content:</strong> <code>${nfcString}</code><br>
                <strong>QR Code URL (for sharing):</strong> <code>${landingPageUrl}</code><br>
                <strong>Tasker Intent URL (Advanced):</strong> <code>${intentUrl}</code>`;
                
            DOMElements.nfcStringEl.textContent = nfcString;
            generateQRCode(landingPageUrl); // Generate QR code with the new landing page URL
        
            //-- show the new button & give it the link
            DOMElements.postUploadButtons.style.display = 'flex';
            DOMElements.downloadProcedureBtn.onclick = () => window.location.href = intentUrl;
        
            // Show the Share button
            document.getElementById('share-btn').style.display = 'inline-block';
        
            DOMElements.linksSection.style.display = 'block';
            DOMElements.linksSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        async function handleShare() {
            const shareBtn = document.getElementById('share-btn');
            const originalText = shareBtn.textContent;
            shareBtn.textContent = 'Preparing...';
        
            // Get the landing page URL from the info section
            const landingPageUrl = DOMElements.infoSection.querySelector('code:nth-of-type(5)').textContent;
            const title = `Procedure: ${currentProcedure.data.title}`;
            const text = `Here is the procedure "${currentProcedure.data.title}". Scan the QR code or use the link to download it.`;
        
            // Check if Web Share API is supported
            if (!navigator.share) {
                alert('Web Share API is not supported on this browser. Try copying the link manually.');
                shareBtn.textContent = originalText;
                return;
            }
        
            try {
                // Convert canvas QR code to a Blob to make it shareable
                const canvas = DOMElements.qrCanvas;
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], `${currentProcedure.filename}_qr.png`, { type: 'image/png' });
        
                // Share the URL, text, and the QR code file
                await navigator.share({
                    title: title,
                    text: text,
                    url: landingPageUrl,
                    files: [file]
                });
                shareBtn.textContent = 'Shared!';
        
            } catch (error) {
                console.error('Share failed:', error);
                shareBtn.textContent = 'Share Canceled';
            } finally {
                setTimeout(() => { shareBtn.textContent = originalText; }, 3000);
            }
        }
        
        // --- FILE HANDLING & HELPERS ---
        function handleJSONUpload(event) {
            const file = event.target.files[0];
            if (!file || !file.name.endsWith('.json')) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    populateFormFromJSON(jsonData);
                } catch (error) {
                    alert('Invalid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        function populateFormFromJSON(data) {
            if (!data.title || !data.instructions || !Array.isArray(data.instructions)) {
                alert('Invalid JSON format.');
                return;
            }
            DOMElements.titleInput.value = data.title;
            DOMElements.instructionsContainer.innerHTML = ''; // Clear existing
            data.instructions.forEach(item => {
                const newContainer = createInstructionContainer(item.instruction || item);
                DOMElements.instructionsContainer.appendChild(newContainer);
            });
            updateStepNumbers();
            updateStatusBar();
            alert(`Loaded "${data.title}" with ${data.instructions.length} steps.`);
        }

        function generateQRCode(text) {
            if (typeof QRious === 'undefined') {
                console.error('QRious library not loaded');
                DOMElements.qrCanvas.getContext('2d').fillText('QR Library Error', 10, 100);
                return;
            }
            new QRious({ element: DOMElements.qrCanvas, value: text, size: 200 });
        }
        
        const copyToClipboard = (text, btn, successText) => {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = successText;
                setTimeout(() => { btn.textContent = originalText; }, 2000);
            }).catch(err => alert('Failed to copy.'));
        };

        function downloadFile() {
            if (!currentProcedure) return;
            const jsonString = JSON.stringify(currentProcedure.data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentProcedure.filename}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            DOMElements.form.addEventListener('submit', (e) => {
                e.preventDefault();
                handleGenerateProcedure();
            });
            
            DOMElements.addBtn.addEventListener('click', () => addInstruction());
            DOMElements.uploadBtn.addEventListener('click', () => DOMElements.jsonUploadInput.click());
            DOMElements.jsonUploadInput.addEventListener('change', handleJSONUpload);
            
            DOMElements.copyJsonBtn.addEventListener('click', (e) => copyToClipboard(DOMElements.jsonDisplay.textContent, e.target, 'COPIED!'));
            DOMElements.downloadFileBtn.addEventListener('click', downloadFile);
            DOMElements.uploadProcedureBtn.addEventListener('click', uploadProcedure);
            DOMElements.copyNfcBtn.addEventListener('click', (e) => copyToClipboard(DOMElements.nfcStringEl.textContent, e.target, 'COPIED!'));
            document.getElementById('share-btn').addEventListener('click', handleShare);

            DOMElements.titleInput.addEventListener('input', updateStatusBar);
            
            // Start with 3 empty instruction fields
            for(let i=0; i < 3; i++) {
                addInstruction(false);
            }
            updateStatusBar();
        });

    </script>
</body>
</html>
